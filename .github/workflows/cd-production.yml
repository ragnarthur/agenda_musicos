name: CD Production

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      mode:
        description: "Acao remota no servidor"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - status

permissions:
  contents: read

concurrency:
  group: cd-production
  cancel-in-progress: false

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: [self-hosted, prod-server]
    environment: production
    steps:
      - name: Definir diretorio da aplicacao
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="${{ secrets.PROD_APP_DIR }}"
          if [ -z "${APP_DIR:-}" ]; then
            APP_DIR="/opt/agenda-musicos/agenda_musicos"
          fi
          [ -d "$APP_DIR" ] || { echo "Diretorio da app nao existe: $APP_DIR"; exit 1; }
          echo "APP_DIR=$APP_DIR" >> "$GITHUB_ENV"

      - name: Mostrar contexto do disparo
        shell: bash
        run: |
          echo "event_name=$GITHUB_EVENT_NAME"
          echo "runner_name=$RUNNER_NAME"
          echo "runner_os=$RUNNER_OS"
          if [ "$GITHUB_EVENT_NAME" = "workflow_run" ]; then
            echo "ci_conclusion=${{ github.event.workflow_run.conclusion }}"
            echo "ci_head_sha=${{ github.event.workflow_run.head_sha }}"
            echo "ci_head_branch=${{ github.event.workflow_run.head_branch }}"
          else
            echo "manual_mode=${{ github.event.inputs.mode }}"
          fi

      - name: Executar deploy remoto
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'deploy')
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          ./deploy.sh deploy

      - name: Consultar status remoto
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'status')
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          ./deploy.sh status

      - name: Verificacao final da stack
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          docker compose --env-file .env.prod -f docker-compose.prod.yml ps
