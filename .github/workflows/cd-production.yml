name: CD Production

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      mode:
        description: "Acao remota no servidor"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - status

permissions:
  contents: read

concurrency:
  group: cd-production
  cancel-in-progress: false

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: [self-hosted, prod-server]
    timeout-minutes: 25
    environment: production
    steps:
      - name: Definir diretorio da aplicacao
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="${{ secrets.PROD_APP_DIR }}"
          if [ -z "${APP_DIR:-}" ]; then
            APP_DIR="/opt/agenda-musicos/agenda_musicos"
          fi
          [ -d "$APP_DIR" ] || { echo "Diretorio da app nao existe: $APP_DIR"; exit 1; }
          echo "APP_DIR=$APP_DIR" >> "$GITHUB_ENV"

      - name: Mostrar contexto do disparo
        shell: bash
        run: |
          echo "event_name=$GITHUB_EVENT_NAME"
          echo "runner_name=$RUNNER_NAME"
          echo "runner_os=$RUNNER_OS"
          if [ "$GITHUB_EVENT_NAME" = "workflow_run" ]; then
            echo "ci_conclusion=${{ github.event.workflow_run.conclusion }}"
            echo "ci_head_sha=${{ github.event.workflow_run.head_sha }}"
            echo "ci_head_branch=${{ github.event.workflow_run.head_branch }}"
          else
            echo "manual_mode=${{ github.event.inputs.mode }}"
          fi

      - name: Executar deploy remoto
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'deploy')
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          if command -v timeout >/dev/null 2>&1; then
            timeout --foreground 20m ./deploy.sh deploy
          else
            ./deploy.sh deploy
          fi

      - name: Consultar status remoto
        if: github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'status')
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          if command -v timeout >/dev/null 2>&1; then
            timeout --foreground 3m ./deploy.sh status
          else
            ./deploy.sh status
          fi

      - name: Validar healthz e readyz
        shell: bash
        run: |
          set -euo pipefail
          DOMAIN="${{ secrets.PROD_DOMAIN }}"
          if [ -z "${DOMAIN:-}" ]; then
            DOMAIN="gigflowagenda.com.br"
          fi
          API_DOMAIN="${{ secrets.PROD_API_DOMAIN }}"
          if [ -z "${API_DOMAIN:-}" ]; then
            API_DOMAIN="api.${DOMAIN}"
          fi

          check_url () {
            local url="$1"
            local label="$2"
            local host="$3"
            local attempts=10
            local wait_seconds=5
            local code="000"

            echo "Validando ${label}: ${url}"
            for i in $(seq 1 "$attempts"); do
              code=$(curl -sS -o /dev/null -w "%{http_code}" --connect-timeout 3 --max-time 8 --resolve "${host}:443:127.0.0.1" "$url" || echo "000")
              if [ "$code" = "200" ]; then
                echo "${label} OK (200)"
                return 0
              fi
              echo "Tentativa ${i}/${attempts} => HTTP ${code}"
              sleep "$wait_seconds"
            done

            echo "Falha ao validar ${label}. Ultimo status: ${code}"
            return 1
          }

          check_url "https://${DOMAIN}/healthz/" "healthz" "${DOMAIN}"
          check_url "https://${DOMAIN}/api/readyz/" "readyz-main-domain" "${DOMAIN}"
          check_url "https://${API_DOMAIN}/api/readyz/" "readyz-api-domain" "${API_DOMAIN}"

      - name: Verificacao final da stack
        shell: bash
        run: |
          set -euo pipefail
          cd "$APP_DIR"
          docker compose --env-file .env.prod -f docker-compose.prod.yml ps

      - name: Coletar diagnostico em falha
        if: failure()
        shell: bash
        run: |
          set +e
          cd "$APP_DIR"
          echo "== docker compose ps =="
          docker compose --env-file .env.prod -f docker-compose.prod.yml ps
          echo "== ultimos logs (backend/frontend/nginx) =="
          docker compose --env-file .env.prod -f docker-compose.prod.yml logs --tail=120 backend frontend nginx
